---
export const prerender = false;

import PocketBase from '../../../public/lib/pocketbase.mjs';
import Layout from "../../layouts/Layout.astro";
import Header from "../../components/Headersite.astro";
import Footer from "../../components/Footer.astro";

const pb = new PocketBase('https://hacksterix.adrienchoulet.fr');
const questions = await pb.collection('quiz').getFullList({
  sort: '+created',
  perPage: 5,
});

const first = questions[0];
const rest = questions.slice(1);
---

<Layout>
  <Header />

  <section class="text-white px-6 py-20 max-w-3xl mx-auto space-y-10">
    <h1 class="text-3xl font-bold text-center">D√©fi cybers√©curit√©</h1>

  
    <div id="quiz-container" class="space-y-6">
      <h2 class="text-xl font-semibold">{first.questions}</h2>
      <form id="quiz-form" class="space-y-2">
        <label class="block bg-neutral-800 px-4 py-2 rounded cursor-pointer hover:bg-fuchsia-700">
          <input type="radio" name="answer" value="reponse_1" class="mr-2" />
          {first.reponse_1}
        </label>
        <label class="block bg-neutral-800 px-4 py-2 rounded cursor-pointer hover:bg-fuchsia-700">
          <input type="radio" name="answer" value="reponse_2" class="mr-2" />
          {first.reponse_2}
        </label>
        <label class="block bg-neutral-800 px-4 py-2 rounded cursor-pointer hover:bg-fuchsia-700">
          <input type="radio" name="answer" value="reponse_3" class="mr-2" />
          {first.reponse_3}
        </label>
        <label class="block bg-neutral-800 px-4 py-2 rounded cursor-pointer hover:bg-fuchsia-700">
          <input type="radio" name="answer" value="reponse_4" class="mr-2" />
          {first.reponse_4}
        </label>

        <button type="submit" class="mt-4 bg-fuchsia-600 hover:bg-fuchsia-700 px-4 py-2 rounded">Suivant</button>
      </form>
    </div>
  </section>

  <Footer />

  <!--  Injecte les autres questions (s√©rialis√©es) -->
  <script id="quiz-data" type="application/json" is:inline>
    {JSON.stringify(rest)}
  </script>

  <!--  JS pour g√©rer les questions suivantes -->
  <script type="module">
    const restQuestions = JSON.parse(document.getElementById("quiz-data").textContent);
    let currentIndex = 0;
    let score = 0;

    // V√©rifie la 1√®re r√©ponse
    document.getElementById("quiz-form").addEventListener("submit", (e) => {
      e.preventDefault();
      const selected = document.querySelector("input[name='answer']:checked");
      if (!selected) return alert("Choisis une r√©ponse !");
      
      // üí° 1re question hardcod√©e pour comparaison
      if (["reponse_1", "reponse_2"].includes(selected.value)) score++;

      renderNext();
    });

    function renderNext() {
      if (currentIndex >= restQuestions.length) {
        showResults();
        return;
      }

      const q = restQuestions[currentIndex];
      const container = document.getElementById("quiz-container");
      container.innerHTML = `
        <div class="space-y-4">
          <h2 class="text-xl font-semibold">${q.questions}</h2>
          <form id="quiz-form" class="space-y-2">
            ${[1, 2, 3, 4].map(i => `
              <label class="block bg-neutral-800 px-4 py-2 rounded cursor-pointer hover:bg-fuchsia-700">
                <input type="radio" name="answer" value="reponse_${i}" class="mr-2" />
                ${q['reponse_' + i]}
              </label>
            `).join('')}
            <button type="submit" class="mt-4 bg-fuchsia-600 hover:bg-fuchsia-700 px-4 py-2 rounded">Suivant</button>
          </form>
        </div>
      `;

      document.getElementById("quiz-form").addEventListener("submit", (e) => {
        e.preventDefault();
        const selected = document.querySelector("input[name='answer']:checked");
        if (!selected) return alert("Choisis une r√©ponse !");
        if (Array.isArray(q.bonne_reponse) && q.bonne_reponse.includes(selected.value)) score++;

        currentIndex++;
        renderNext();
      });
    }

    function showResults() {
      const container = document.getElementById("quiz-container");
      container.innerHTML = `
        <div class="text-center space-y-4">
          <h2 class="text-2xl font-bold text-green-400">üéâ F√©licitations !</h2>
          <p>Tu as obtenu <strong>${score}</strong> / ${restQuestions.length + 1} bonnes r√©ponses.</p>
          <img src="/Badge${score >= 4 ? 2 : 1}.png" alt="Badge" class="w-24 mx-auto" />
        </div>
      `;
    }
  </script>
</Layout>
